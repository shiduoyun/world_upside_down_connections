<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WGSS 300 Genealogy: Contextualized & Thematic</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="bookNodes.js"></script>
    <script src="links.js"></script>
    <style>
        html, body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 20px;
            overflow-x: auto; /* allow horizontal scrolling for wide timelines */
        }
        h1 { text-align: center; color: #333; margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 20px; }
        
        #chart-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 30px 0;
            min-width: 1300px;
        }
        svg { display: block; }

        /* Tooltip 样式增强 */
        .tooltip {
            position: absolute;
            text-align: left;
            max-width: 350px;
            padding: 15px;
            font-size: 13px;
            line-height: 1.5;
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .tooltip strong.title { font-size: 15px; color: #ffdd57; display: block; margin-bottom: 4px; }
        .tooltip .meta { color: #bbb; font-size: 12px; margin-bottom: 10px; display: block; }
        .tooltip .section-label { font-weight: bold; color: #ddd; margin-top: 8px; display: block; }
        
        .axis-label { font-size: 12px; font-weight: bold; fill: #888; text-anchor: end; }
        .tick text { font-size: 11px; fill: #555; }
        
        /* LINK */
        .link { fill: none; stroke: #999; stroke-opacity: 0.3; stroke-width: 1.5px; transition: all 0.3s; cursor: pointer; }
        /* MOUSE HOVER TURN RED */
        .link.highlighted { stroke-opacity: 1; stroke: #d62728 !important; stroke-width: 3px; }
        
        /* BOOK NODE DESIGN */
        .node circle { cursor: pointer; transition: all 0.3s; stroke: #fff; stroke-width: 2px; }
        .node:hover circle { stroke: #333; stroke-width: 3px; r: 12px !important; }
        
        /* COUNTOUR TO ADD READABAILITY */
        .node text { 
            font-size: 11px; fill: #222; text-anchor: middle; pointer-events: none; 
            paint-order: stroke; stroke: #fff; stroke-width: 4px; stroke-linecap: round; stroke-linejoin: round; font-weight: 600;
        }

        .legend { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; font-size: 14px; color: #555; }
        .legend-item { display: flex; align-items: center; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    
    <h1>WGSS 300: Intellectual Genealogy Map</h1>
    <p class="subtitle">Hover over circles for book details. <strong>Hover over connecting lines to see the relationship.</strong></p>
    
    <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#4e79a7"></div>Institutional</div>
        <div class="legend-item"><div class="legend-dot" style="background:#e15759"></div>Group</div>
        <div class="legend-item"><div class="legend-dot" style="background:#76b7b2"></div>Individual</div>
    </div>

    <div id="chart-container"></div>
    <div class="tooltip" id="tooltip"></div>

<script>
    // === 1. DATA PREP ===
    
    // bookNodes is loaded from bookNodes.js (generated by work_to_nodes.R)

    // Merge nodes for simulation (books only)
    const allNodes = [...bookNodes];

    // === 2. CANVAS SETUP ===
    const margin = {top: 60, right: 100, bottom: 80, left: 150};
    const years = Array.from(new Set(bookNodes.map(d => d.year))).sort((a,b) => a-b);
    const yearPositions = years.map((y, i) => ({ year: y, pos: i + 1 }));
    const yearToPos = new Map(yearPositions.map(d => [d.year, d.pos]));
    const width = Math.max(yearPositions.length * 80, document.getElementById('chart-container').offsetWidth) - margin.left - margin.right;
    const height = 700 - margin.top - margin.bottom;

    const svg = d3.select("#chart-container")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // === 3.SCALES ===
    // Use ordinal-like spacing for years so early works aren't pushed far left
    const x = d3.scaleLinear()
        .domain([0.5, yearPositions.length + 0.5])
        .range([0, width]);
    const y = d3.scaleOrdinal().domain([1, 2, 3]).range([height * 0.15, height * 0.5, height * 0.85]);
    const color = d3.scaleOrdinal().domain([1, 2, 3]).range(["#4e79a7", "#e15759", "#76b7b2"]);

    // === 4.FORCE SIMULATION ===
    const simulation = d3.forceSimulation(allNodes)
        .force("x", d3.forceX(d => x(yearToPos.get(d.year))).strength(1))
        .force("y", d3.forceY(d => y(d.level)).strength(0.5))
        .force("collide", d3.forceCollide(() => 20).strength(0.8)) // 防止重叠
        .stop();

    for (let i = 0; i < 150; ++i) simulation.tick();

    // === 5. BACKGROUND ELEMENTS ===
    // GRID LINES AND ZONES
    const zones = ["Institutional / Law / State", "Group / Class / Race", "Individual / Subject / Body"];
    zones.forEach((label, i) => {
        const yPos = y(i + 1);
        svg.append("line").attr("class", "grid-line")
           .attr("x1", 0).attr("x2", width).attr("y1", yPos).attr("y2", yPos)
           .attr("stroke", "#eee").attr("stroke-width", 1).attr("stroke-dasharray", "5,5");
        svg.append("text").attr("class", "axis-label")
           .attr("x", -20).attr("y", yPos + 4).text(label);
    });

    // X AXIS
    const xAxis = d3.axisBottom(x)
        .tickValues(yearPositions.map(d => d.pos))
        .tickFormat((_, i) => yearPositions[i]?.year ?? "");
    svg.append("g").attr("transform", `translate(0, ${height + 30})`).call(xAxis)
       .selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-45)");


    // === 6. LINKS ===

    // 6.1 Book Connections - with Context Tooltip
    const linkData = links.map(l => {
        const src = bookNodes.find(n => n.id === l.source);
        const tgt = bookNodes.find(n => n.id === l.target);
        return (src && tgt) ? { source: src, target: tgt, relation: l.relation } : null;
    }).filter(d => d);

    const linkPaths = svg.selectAll(".link")
        .data(linkData)
        .enter().append("path")
        .attr("class", "link")
        .attr("d", d => {
            const sx = d.source.x, sy = d.source.y;
            const tx = d.target.x, ty = d.target.y;
            // BEZIER CURVE PATH
            const dx = tx - sx; const dy = ty - sy;
            const dr = Math.sqrt(dx * dx + dy * dy) * 1.5; 
            return `M${sx},${sy}A${dr},${dr} 0 0,1 ${tx},${ty}`;
        });

    // === 7. NODES ===
    const tooltip = d3.select("#tooltip");

    // 7.1 BOOK NODES
    const bookNodeGroup = svg.selectAll(".book-node")
        .data(bookNodes)
        .enter().append("g")
        .attr("class", "node book-node")
        .attr("transform", d => `translate(${d.x}, ${d.y})`);
    
    bookNodeGroup.append("circle") //Standard Book Node Circle
        .attr("r", 9)
        .attr("fill", d => color(d.level));

    // LABEL: Author: Short Title
    bookNodeGroup.append("text")
        .text(d => `${d.author}: ${d.shortTitle}`)
        .attr("y", (d, i) => i % 2 === 0 ? -18 : 24); // Alternate above/below for readability

    // === 8. Interactions

    // 8.1 MOUSEOVER LINK TO SHOW RELATIONSHIP TOOLTIP
    linkPaths.on("mouseover", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", true);
        // Bring to front
        event.currentTarget.parentNode.appendChild(event.currentTarget);

        tooltip.style("opacity", 1)
            .html(`
                <span class="section-label" style="color:#ff6b6b">Connection Relationship:</span>
                <div style="margin-bottom:8px; font-size:14px;">
                    <strong>${d.source.author}</strong> → <strong>${d.target.author}</strong>
                </div>
                <em style="color:#eee; line-height:1.4;">"${d.relation}"</em>
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px");
    }).on("mouseout", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", false);
        tooltip.style("opacity", 0);
    });

    // 8.2 NODE INTERACTIONS
    bookNodeGroup.on("mouseover", (event, d) => {
        d3.select(event.currentTarget).select("circle").attr("r", 14);
        
        tooltip.style("opacity", 1)
            .html(`
                <strong class="title">${d.title}</strong>
                <span class="meta">${d.author}, ${d.year}</span>
                
                <span class="section-label">Key Concepts:</span>
                <span style="color:#ccc">${d.concepts}</span>
                
                <span class="section-label">Summary for the Public Reader:</span>
                <p style="margin:5px 0 0 0; color:#eee; font-style:italic;">${d.summary}</p>
            `)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 100) + "px");
    }).on("mouseout", (event, d) => {
        d3.select(event.currentTarget).select("circle").attr("r", 9);
        tooltip.style("opacity", 0);
    });
    
</script>
</body>
</html>
