<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WGSS 300 Genealogy: Contextualized & Thematic</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="bookNodes.js"></script>
    <script src="links.js"></script>
    <style>
        html, body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #fdf6e3;
            color: #657b83;
            margin: 20px;
            overflow-x: auto; /* allow horizontal scrolling for wide timelines */
        }
        h1 { text-align: center; color: #586e75; margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #93a1a1; font-size: 14px; margin-bottom: 20px; }
        
        #chart-container {
            width: 100%;
            overflow-x: auto;
            background: #fefbec;
            box-shadow: 0 4px 8px rgba(88,110,117,0.12);
            border-radius: 12px;
            padding: 30px 0;
            min-width: 1300px;
        }
        svg { display: block; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            text-align: left;
            max-width: 350px;
            padding: 15px;
            font-size: 13px;
            line-height: 1.5;
            background: rgba(7, 54, 66, 0.95); /* base03 */
            color: #eee8d5;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 6px 15px rgba(7,54,66,0.4);
            z-index: 1000;
            border: 1px solid rgba(147,161,161,0.4);
        }
        .tooltip strong.title { font-size: 15px; color: #b58900; display: block; margin-bottom: 4px; }
        .tooltip .meta { color: #93a1a1; font-size: 12px; margin-bottom: 10px; display: block; }
        .tooltip .section-label { font-weight: bold; color: #eee8d5; margin-top: 8px; display: block; }
        
        .axis-label { font-size: 12px; font-weight: bold; fill: #839496; text-anchor: end; }
        .tick text { font-size: 11px; fill: #657b83; }
        
        /* LINK */
        .link { fill: none; transition: all 0.3s; cursor: pointer; }
        .link.highlighted { stroke-opacity: 1; stroke-width: 3px; }

        /* BOOK NODE DESIGN */
        .node circle { cursor: pointer; transition: all 0.3s; stroke: #fff; stroke-width: 2px; }
        .node:hover circle { stroke: #073642; stroke-width: 3px; }
        .node.highlighted circle { stroke: #dc322f; stroke-width: 3px; fill: #fdf6e3; }
        
        /* COUNTOUR TO ADD READABAILITY */
        .node text { 
            font-size: 11px; fill: #586e75; text-anchor: middle; pointer-events: none; 
            paint-order: stroke; stroke: #fefbec; stroke-width: 4px; stroke-linecap: round; stroke-linejoin: round; font-weight: 600;
        }

        .legend { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; font-size: 14px; color: #657b83; }
        .legend-item { display: flex; align-items: center; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 2px solid #fefbec; box-shadow: 0 0 2px rgba(88,110,117,0.2); }
    </style>
</head>
<body>
    
    <h1>WGSS 300 Concept Map Timeline</h1>
    <p class="subtitle">Hover over circles for book details. <strong>Hover over connecting lines to see the relationship.</strong></p>
    
    <div id="chart-container"></div>
    <div class="tooltip" id="tooltip"></div>

<script>
    // === 1. DATA PREP ===
    
    // bookNodes is loaded from bookNodes.js (generated by work_to_nodes.R)

    // Merge nodes for simulation (books only)
    const allNodes = [...bookNodes];

    // Link color scale by category (Solarized accents with explicit Critical)
    const linkCategories = Array.from(new Set(links.map(l => l.category || "Other")));
    const solarizedAccents = ["#268bd2", "#2aa198", "#859900", "#b58900", "#cb4b16", "#dc322f", "#d33682", "#6c71c4"];
    const linkColor = d3.scaleOrdinal()
        .domain(linkCategories)
        .range(solarizedAccents.slice(0, linkCategories.length));

    // Add a simple legend for link categories
    const legendContainer = d3.select("body")
        .insert("div", "#chart-container")
        .attr("class", "legend")
        .style("display", "flex")
        .style("justify-content", "center")
        .style("gap", "16px")
        .style("margin-bottom", "10px");

    linkCategories.forEach(cat => {
        const item = legendContainer.append("div").attr("class", "legend-item").style("display", "flex").style("align-items", "center").style("font-size", "14px").style("color", "#657b83");
        item.append("div")
            .style("width", "12px")
            .style("height", "12px")
            .style("border-radius", "50%")
            .style("margin-right", "6px")
            .style("background", linkColor(cat));
        item.append("span").text(cat);
    });

    // === 2. CANVAS SETUP ===
    const margin = {top: 60, right: 100, bottom: 80, left: 150};
    const years = Array.from(new Set(bookNodes.map(d => d.year))).sort((a,b) => a-b);
    const yearPositions = years.map((y, i) => ({ year: y, pos: i + 1 }));
    const yearToPos = new Map(yearPositions.map(d => [d.year, d.pos]));
    const width = Math.max(yearPositions.length * 80, document.getElementById('chart-container').offsetWidth) - margin.left - margin.right;
    const height = 700 - margin.top - margin.bottom;

    const svg = d3.select("#chart-container")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // === 3.SCALES ===
    // Use ordinal-like spacing for years so early works aren't pushed far left
    const x = d3.scaleLinear()
        .domain([0.5, yearPositions.length + 0.5])
        .range([0, width]);
    const y = d3.scaleOrdinal().domain([1, 2, 3]).range([height * 0.15, height * 0.5, height * 0.85]);

    // === 4.FORCE SIMULATION ===
    const simulation = d3.forceSimulation(allNodes)
        .force("x", d3.forceX(d => x(yearToPos.get(d.year))).strength(1))
        .force("y", d3.forceY(d => y(d.level)).strength(0.5))
        .force("collide", d3.forceCollide(() => 20).strength(0.8)) 
        .stop();

    for (let i = 0; i < 150; ++i) simulation.tick();

    // === 5. BACKGROUND ELEMENTS ===
    // GRID LINES AND ZONES
    const zones = ["Institutional", "Group", "Individual"];
    zones.forEach((label, i) => {
        const yPos = y(i + 1);
        svg.append("line").attr("class", "grid-line")
           .attr("x1", 0).attr("x2", width).attr("y1", yPos).attr("y2", yPos)
           .attr("stroke", "#eee").attr("stroke-width", 1).attr("stroke-dasharray", "5,5");
        svg.append("text").attr("class", "axis-label")
           .attr("x", -20).attr("y", yPos + 4).text(label);
    });

    // X AXIS
    const xAxis = d3.axisBottom(x)
        .tickValues(yearPositions.map(d => d.pos))
        .tickFormat((_, i) => yearPositions[i]?.year ?? "");
    svg.append("g").attr("transform", `translate(0, ${height + 30})`).call(xAxis)
       .selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-45)");


    // === 6. LINKS ===

    // 6.1 Book Connections - with Context Tooltip
    const linkData = links.map(l => {
        const src = bookNodes.find(n => n.id === l.source);
        const tgt = bookNodes.find(n => n.id === l.target);
        return (src && tgt) ? { source: src, target: tgt, relation: l.relation, category: l.category || "Other" } : null;
    }).filter(d => d);

    const linkPaths = svg.selectAll(".link")
        .data(linkData)
        .enter().append("path")
        .attr("class", "link")
        .attr("stroke", d => linkColor(d.category))
        .attr("stroke-opacity", 0.2)
        .attr("stroke-width", 2)
        .attr("d", d => {
            const sx = d.source.x, sy = d.source.y;
            const tx = d.target.x, ty = d.target.y;
            // BEZIER CURVE PATH
            const dx = tx - sx; const dy = ty - sy;
            const dr = Math.sqrt(dx * dx + dy * dy) * 1.5; 
            return `M${sx},${sy}A${dr},${dr} 0 0,1 ${tx},${ty}`;
        });

    // === 7. NODES ===
    const tooltip = d3.select("#tooltip");

    // 7.1 BOOK NODES
    const bookNodeGroup = svg.selectAll(".book-node")
        .data(bookNodes)
        .enter().append("g")
        .attr("class", "node book-node")
        .attr("transform", d => `translate(${d.x}, ${d.y})`);
    
    bookNodeGroup.append("circle") 
        .attr("r", 6)
        .attr("fill", d => d.category === "Influence" ? "#d9cca3" : "#586e75");

    // LABEL: Author: Short Title
    bookNodeGroup.append("text")
        .text(d => `${d.author}: ${d.shortTitle}`)
        .attr("y", (d, i) => i % 2 === 0 ? -18 : 24); // Alternate above/below for readability

    // === 8. Interactions

    // Utility helpers to sync highlights between nodes and all connected bezier links.
    const highlightNodesForLink = (link, highlighted) => {
        bookNodeGroup
            .filter(n => n.id === link.source.id || n.id === link.target.id)
            .classed("highlighted", highlighted);
    };

    const highlightLinksForNode = (node, highlighted) => {
        linkPaths
            .filter(l => l.source.id === node.id || l.target.id === node.id)
            .classed("highlighted", highlighted)
            .attr("stroke-opacity", highlighted ? 1 : 0.2);
    };

    // 8.1 MOUSEOVER LINK TO SHOW RELATIONSHIP TOOLTIP
    linkPaths.on("mouseover", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", true).attr("stroke-opacity", 1);
        highlightNodesForLink(d, true);
        // Bring to front
        event.currentTarget.parentNode.appendChild(event.currentTarget);

        tooltip.style("opacity", 1)
            .html(`
                <span class="section-label" style="color:#dc322f">Connection Relationship:</span>
                <div style="margin-bottom:8px; font-size:14px;">
                    <strong>${d.source.author}</strong> â†’ <strong>${d.target.author}</strong>
                </div>
                <em style="color:#eee; line-height:1.4;">"${d.relation}"</em>
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px");
    }).on("mouseout", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", false).attr("stroke-opacity", 0.2);
        highlightNodesForLink(d, false);
        tooltip.style("opacity", 0);
    });

    // 8.2 NODE INTERACTIONS
    bookNodeGroup.on("mouseover", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", true);
        highlightLinksForNode(d, true);
        tooltip.style("opacity", 1)
            .html(`
                <strong class="title">${d.title}</strong>
                <span class="meta">${d.author}, ${d.year}</span>
                
                <span class="section-label">Key Concepts:</span>
                <span style="color:#93a1a1">${d.concepts}</span>
                
                <span class="section-label">Summary:</span>
                <p style="margin:5px 0 0 0; color:#eee; font-style:italic;">${d.summary}</p>
            `)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 100) + "px");
    }).on("mouseout", (event, d) => {
        d3.select(event.currentTarget).classed("highlighted", false);
        highlightLinksForNode(d, false);
        tooltip.style("opacity", 0);
    });
    
</script>
</body>
</html>
